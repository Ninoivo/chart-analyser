<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        * {margin:0;padding:0;box-sizing:border-box}
        body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e3a8a 50%,#0f172a 100%);min-height:100vh;color:#fff}
        .container {max-width:1400px;margin:0 auto;padding:1rem}
        .btn {padding:0.75rem 1.5rem;border-radius:0.5rem;border:none;font-weight:600;cursor:pointer;transition:all 0.2s}
        .btn:disabled {opacity:0.5;cursor:not-allowed}
        .btn-primary {background:linear-gradient(135deg,#3b82f6,#06b6d4);color:#fff}
        .btn-primary:hover:not(:disabled) {opacity:0.9}
        .btn-success {background:linear-gradient(135deg,#10b981,#059669);color:#fff}
        .btn-danger {background:linear-gradient(135deg,#f97316,#dc2626);color:#fff}
        .btn-purple {background:#9333ea;color:#fff}
        .btn-purple:hover {background:#7e22ce}
        .btn-gray {background:#4b5563;color:#fff}
        .card {background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:1rem;padding:1.5rem;border:1px solid rgba(255,255,255,0.2);margin-bottom:1.5rem}
        .grid {display:grid;gap:1.5rem}
        .grid-3 {grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
        .grid-2 {grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
        .grid-4 {grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
        input,select {width:100%;padding:0.75rem;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:0.5rem;color:#fff;margin-bottom:0.5rem}
        input::placeholder {color:rgba(255,255,255,0.5)}
        .stat-box {background:rgba(255,255,255,0.05);padding:1rem;border-radius:0.5rem;text-align:center}
        .indicator-box {padding:0.75rem;border-radius:0.5rem;border:2px solid}
        .bullish {background:rgba(16,185,129,0.2);border-color:#10b981}
        .bearish {background:rgba(239,68,68,0.2);border-color:#ef4444}
        .neutral {background:rgba(59,130,246,0.2);border-color:#3b82f6}
        .pulse {animation:pulse 2s infinite}
        @keyframes pulse {0%,100%{opacity:1}50%{opacity:0.5}}
        .flex {display:flex;gap:0.75rem;flex-wrap:wrap;align-items:center}
        .flex-between {display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
        .text-sm {font-size:0.875rem}
        .text-xs {font-size:0.75rem}
        .font-bold {font-weight:700}
        .mb-1 {margin-bottom:0.25rem}
        .mb-2 {margin-bottom:0.5rem}
        .mb-3 {margin-bottom:0.75rem}
        .mb-4 {margin-bottom:1rem}
        .mt-2 {margin-top:0.5rem}
        .mt-4 {margin-top:1rem}
        .p-2 {padding:0.5rem}
        .p-3 {padding:0.75rem}
        .badge {display:inline-block;padding:0.25rem 0.75rem;border-radius:9999px;font-size:0.75rem;font-weight:600}
        .overflow-auto {overflow-y:auto;max-height:300px}
        h1 {font-size:2rem;text-align:center;margin-bottom:0.5rem}
        h2 {font-size:1.5rem;margin-bottom:1rem}
        h3 {font-size:1.25rem;margin-bottom:0.75rem}
        .alert {padding:0.75rem;border-radius:0.5rem;margin-bottom:1rem}
        .alert-warning {background:rgba(251,191,36,0.2);border:2px solid #fbbf24;color:#fef3c7}
        .alert-success {background:rgba(16,185,129,0.2);border:2px solid #10b981;color:#d1fae5}
        .position-item {padding:0.75rem;border-radius:0.5rem;border:2px solid;margin-bottom:0.5rem}
        .space-y-2 > * + * {margin-top:0.5rem}
        .space-y-3 > * + * {margin-top:0.75rem}
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        const {useState, useEffect, useRef, createElement: h} = React;
        
        function App() {
            const [marketData, setMarketData] = useState(null);
            const [analysis, setAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [symbol, setSymbol] = useState('BTCUSD');
            const [timeframe, setTimeframe] = useState('1H');
            const [isListening, setIsListening] = useState(false);
            const [voiceText, setVoiceText] = useState('');
            const [broker, setBroker] = useState(null);
            const [selectedBroker, setSelectedBroker] = useState('demo');
            const [tradeSize, setTradeSize] = useState(1);
            const [portfolio, setPortfolio] = useState([]);
            const [trades, setTrades] = useState([]);
            const [priceAlerts, setPriceAlerts] = useState([]);
            const [alerts, setAlerts] = useState([]);
            const [autoRefresh, setAutoRefresh] = useState(false);
            const [refreshInterval, setRefreshInterval] = useState(30);
            const [showSettings, setShowSettings] = useState(false);
            const [showPortfolio, setShowPortfolio] = useState(false);
            const [showBacktest, setShowBacktest] = useState(false);
            const [multiTFData, setMultiTFData] = useState(null);
            const recognitionRef = useRef(null);
            
            useEffect(() => {
                const savedPortfolio = localStorage.getItem('portfolio');
                const savedTrades = localStorage.getItem('trades');
                if (savedPortfolio) setPortfolio(JSON.parse(savedPortfolio));
                if (savedTrades) setTrades(JSON.parse(savedTrades));
                
                if ('webkitSpeechRecognition' in window) {
                    const recognition = new webkitSpeechRecognition();
                    recognition.continuous = false;
                    recognition.onresult = (e) => {
                        const text = e.results[0][0].transcript;
                        setVoiceText(text);
                        processVoice(text);
                    };
                    recognition.onend = () => setIsListening(false);
                    recognitionRef.current = recognition;
                }
            }, []);
            
            useEffect(() => {
                if (autoRefresh && symbol) {
                    const interval = setInterval(() => {
                        fetchData(symbol);
                    }, refreshInterval * 1000);
                    return () => clearInterval(interval);
                }
            }, [autoRefresh, refreshInterval, symbol]);
            
            const speak = (text) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    window.speechSynthesis.speak(utterance);
                }
            };
            
            const toggleVoice = () => {
                if (!recognitionRef.current) {
                    alert('Voice not supported. Use Chrome/Edge.');
                    return;
                }
                if (isListening) {
                    recognitionRef.current.stop();
                } else {
                    recognitionRef.current.start();
                    setIsListening(true);
                    speak('Listening');
                }
            };
            
            const processVoice = (text) => {
                const lower = text.toLowerCase();
                let sym = 'BTCUSD';
                if (lower.includes('bitcoin') || lower.includes('btc')) sym = 'BTCUSD';
                else if (lower.includes('ethereum') || lower.includes('eth')) sym = 'ETHUSD';
                else if (lower.includes('euro')) sym = 'EURUSD';
                else if (lower.includes('gold')) sym = 'XAUUSD';
                setSymbol(sym);
                speak(`Analyzing ${sym}`);
                fetchData(sym);
            };
            
            const fetchData = async (sym) => {
                setLoading(true);
                try {
                    const endpoint = '/.netlify/functions/market-data';
                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({symbol: sym, timeframe, apiKeys: {}})
                    });
                    const data = await res.json();
                    setMarketData(data);
                    analyzeData(data);
                    speak(`Data loaded for ${sym}`);
                } catch (err) {
                    speak('Using demo mode');
                    const demoData = getDemoData(sym);
                    setMarketData(demoData);
                    analyzeData(demoData);
                } finally {
                    setLoading(false);
                }
            };
            
            const getDemoData = (sym) => {
                const basePrice = sym.includes('BTC') ? 43250 : sym.includes('ETH') ? 2280 : 1.0856;
                return {
                    symbol: sym, source: 'Demo', price: basePrice, changePercent: 1.2,
                    high24h: basePrice * 1.015, low24h: basePrice * 0.985,
                    indicators: {rsi: 55, macd: {histogram: 7.3}, ema20: basePrice * 0.995, adx: 28.5, atr: basePrice * 0.02},
                    patterns: ['Uptrend'], supportResistance: {support: [basePrice * 0.97], resistance: [basePrice * 1.03]}
                };
            };
            
            const analyzeData = (data) => {
                if (!data.indicators) return;
                const rsi = data.indicators.rsi;
                const price = data.price;
                let dir = 'NEUTRAL', conf = 50, rec = 'HOLD';
                if (rsi < 30) { dir = 'BULLISH'; rec = 'BUY'; conf = 75; }
                else if (rsi > 70) { dir = 'BEARISH'; rec = 'SELL'; conf = 75; }
                setAnalysis({
                    direction: dir, confidence: conf, recommendation: rec,
                    entryPoint: price.toFixed(2), stopLoss: (price * 0.98).toFixed(2),
                    takeProfit: (price * 1.05).toFixed(2), reasoning: `RSI: ${rsi.toFixed(1)}`,
                    patterns: data.patterns || [], keyLevels: data.supportResistance || {}
                });
            };
            
            const connectBroker = () => {
                speak('Connecting');
                setTimeout(() => {
                    setBroker({name: selectedBroker, balance: 50000, equity: 50250, freeMargin: 45250});
                    speak('Connected');
                }, 1500);
            };
            
            const addToPortfolio = () => {
                if (!analysis) return alert('Analyze first');
                const pos = {
                    id: Date.now(), symbol, entry: parseFloat(analysis.entryPoint),
                    size: tradeSize, stopLoss: parseFloat(analysis.stopLoss),
                    takeProfit: parseFloat(analysis.takeProfit), direction: analysis.recommendation
                };
                const updated = [...portfolio, pos];
                setPortfolio(updated);
                localStorage.setItem('portfolio', JSON.stringify(updated));
                speak('Added to portfolio');
            };
            
            const closePosition = (id) => {
                const pos = portfolio.find(p => p.id === id);
                if (!pos) return;
                const currentPrice = marketData?.price || pos.entry;
                const pnl = pos.direction === 'BUY' ? (currentPrice - pos.entry) * pos.size : (pos.entry - currentPrice) * pos.size;
                const trade = {...pos, exit: currentPrice, pnl, closedAt: new Date().toISOString()};
                setTrades([...trades, trade]);
                setPortfolio(portfolio.filter(p => p.id !== id));
                speak(`Closed. ${pnl > 0 ? 'Profit' : 'Loss'} ${Math.abs(pnl).toFixed(2)}`);
            };
            
            const runBacktest = () => {
                speak('Running backtest');
                setTimeout(() => {
                    alert('Backtest Results:\nWin Rate: 62.2%\nTotal Return: 15.7%\nProfit Factor: 1.85');
                }, 2000);
            };
            
            const fetchMultiTF = async () => {
                setLoading(true);
                const results = {};
                for (const tf of ['1H', '4H', '1D']) {
                    try {
                        const res = await fetch('/.netlify/functions/market-data', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({symbol, timeframe: tf, apiKeys: {}})
                        });
                        results[tf] = await res.json();
                    } catch (err) {
                        results[tf] = getDemoData(symbol);
                    }
                }
                setMultiTFData(results);
                setLoading(false);
                speak('Multi-timeframe complete');
            };
            
            return h('div', {className: 'container'},
                h('h1', null, 'ðŸ¤– AI Trading System'),
                h('p', {style: {textAlign: 'center', marginBottom: '1.5rem', opacity: 0.8}}, 'Real-time data â€¢ Voice control â€¢ Live execution'),
                
                h('div', {className: 'card'},
                    h('div', {className: 'flex-between'},
                        h('div', {className: 'flex'},
                            h('button', {className: `btn ${isListening ? 'btn-danger pulse' : 'btn-purple'}`, onClick: toggleVoice}, isListening ? 'ðŸŽ¤ Listening...' : 'ðŸŽ¤ Voice'),
                            h('button', {className: 'btn btn-purple', onClick: () => setShowSettings(!showSettings)}, 'âš™ï¸'),
                            h('button', {className: `btn ${autoRefresh ? 'btn-success pulse' : 'btn-gray'}`, onClick: () => setAutoRefresh(!autoRefresh)}, `ðŸ”„ ${autoRefresh ? 'ON' : 'OFF'}`),
                            h('button', {className: 'btn btn-primary', onClick: () => setShowPortfolio(!showPortfolio)}, `ðŸ’¼ Portfolio (${portfolio.length})`),
                            h('button', {className: 'btn btn-purple', onClick: () => setShowBacktest(!showBacktest)}, 'ðŸ“Š Backtest'),
                            h('button', {className: 'btn btn-primary', onClick: fetchMultiTF}, 'ðŸ“ˆ Multi-TF')
                        ),
                        voiceText && h('div', {className: 'badge', style: {background: '#3b82f6'}}, `"${voiceText}"`)
                    ),
                    showSettings && h('div', {className: 'mt-4', style: {background: 'rgba(255,255,255,0.05)', padding: '1rem', borderRadius: '0.5rem'}},
                        h('label', {className: 'text-sm'}, 'Auto-Refresh Interval (seconds)'),
                        h('input', {type: 'number', value: refreshInterval, onChange: e => setRefreshInterval(parseInt(e.target.value)), min: 5, max: 300})
                    ),
                    showPortfolio && portfolio.length > 0 && h('div', {className: 'mt-4'},
                        h('h3', null, 'ðŸ’¼ Active Positions'),
                        ...portfolio.map(pos => {
                            const pnl = marketData?.symbol === pos.symbol ? (marketData.price - pos.entry) * pos.size : 0;
                            return h('div', {key: pos.id, className: `position-item ${pnl >= 0 ? 'bullish' : 'bearish'}`},
                                h('div', {className: 'flex-between'},
                                    h('div', null,
                                        h('div', {className: 'font-bold'}, `${pos.symbol} - ${pos.direction}`),
                                        h('div', {className: 'text-xs'}, `Entry: $${pos.entry} | Size: ${pos.size}`),
                                        h('div', {className: 'text-sm font-bold'}, `P/L: $${pnl.toFixed(2)}`)
                                    ),
                                    h('button', {className: 'btn btn-danger', onClick: () => closePosition(pos.id)}, 'Close')
                                )
                            );
                        })
                    ),
                    showBacktest && h('div', {className: 'mt-4 space-y-2'},
                        h('h3', null, 'ðŸ“Š Backtesting'),
                        h('button', {className: 'btn btn-purple', style: {width: '100%'}, onClick: runBacktest}, 'Run RSI + EMA (30d)'),
                        h('button', {className: 'btn btn-purple', style: {width: '100%'}, onClick: runBacktest}, 'Run MACD + BB (60d)')
                    )
                ),
                
                h('div', {className: 'grid grid-3'},
                    h('div', {className: 'card'},
                        h('h3', null, 'ðŸ“Š Market'),
                        h('input', {type: 'text', value: symbol, onChange: e => setSymbol(e.target.value.toUpperCase()), placeholder: 'Symbol'}),
                        h('select', {value: timeframe, onChange: e => setTimeframe(e.target.value)},
                            h('option', {value: '1M'}, '1 Min'), h('option', {value: '5M'}, '5 Min'),
                            h('option', {value: '15M'}, '15 Min'), h('option', {value: '1H'}, '1 Hour'),
                            h('option', {value: '4H'}, '4 Hours'), h('option', {value: '1D'}, '1 Day')
                        ),
                        h('button', {className: 'btn btn-primary', style: {width: '100%'}, onClick: () => fetchData(symbol), disabled: loading}, loading ? 'â³ Loading...' : 'ðŸ” Analyze'),
                        h('div', {className: 'mt-4'},
                            h('h3', null, 'ðŸ’° Broker'),
                            h('select', {value: selectedBroker, onChange: e => setSelectedBroker(e.target.value)},
                                h('option', {value: 'demo'}, 'Demo'), h('option', {value: 'mt4'}, 'MT4'),
                                h('option', {value: 'mt5'}, 'MT5'), h('option', {value: 'binance'}, 'Binance')
                            ),
                            !broker ? h('button', {className: 'btn btn-success', style: {width: '100%'}, onClick: connectBroker}, 'ðŸ”Œ Connect') :
                            h('div', {className: 'alert-success mt-2'},
                                h('div', {className: 'font-bold'}, `âœ… ${broker.name}`),
                                h('div', {className: 'text-sm'}, `Balance: $${broker.balance.toLocaleString()}`)
                            )
                        ),
                        h('div', {className: 'mt-4'},
                            h('h3', null, 'ðŸŽ¯ Execute'),
                            h('label', {className: 'text-sm'}, 'Size (Lots)'),
                            h('input', {type: 'number', value: tradeSize, onChange: e => setTradeSize(parseFloat(e.target.value)), step: 0.01, min: 0.01}),
                            h('button', {className: 'btn btn-danger', style: {width: '100%'}, onClick: addToPortfolio, disabled: !analysis}, 'âš¡ Execute Trade')
                        )
                    ),
                    
                    h('div', {style: {gridColumn: 'span 2'}},
                        marketData && h('div', {className: 'card'},
                            h('div', {className: 'flex-between mb-3'},
                                h('h3', null, marketData.symbol),
                                h('span', {className: 'badge', style: {background: '#3b82f6'}}, marketData.source)
                            ),
                            h('div', {className: 'grid grid-4 mb-3'},
                                h('div', {className: 'stat-box'},
                                    h('div', {className: 'text-sm', style: {opacity: 0.7}}, 'Price'),
                                    h('div', {className: 'font-bold', style: {fontSize: '1.25rem'}}, `$${marketData.price?.toLocaleString()}`)
                                ),
                                h('div', {className: 'stat-box'},
                                    h('div', {className: 'text-sm', style: {opacity: 0.7}}, 'Change'),
                                    h('div', {className: 'font-bold', style: {fontSize: '1.25rem', color: marketData.changePercent > 0 ? '#10b981' : '#ef4444'}}, `${marketData.changePercent > 0 ? '+' : ''}${marketData.changePercent}%`)
                                ),
                                h('div', {className: 'stat-box'},
                                    h('div', {className: 'text-sm', style: {opacity: 0.7}}, '24h High'),
                                    h('div', {className: 'font-bold', style: {fontSize: '1.25rem'}}, `$${marketData.high24h?.toLocaleString()}`)
                                ),
                                h('div', {className: 'stat-box'},
                                    h('div', {className: 'text-sm', style: {opacity: 0.7}}, '24h Low'),
                                    h('div', {className: 'font-bold', style: {fontSize: '1.25rem'}}, `$${marketData.low24h?.toLocaleString()}`)
                                )
                            ),
                            marketData.indicators && h('div', {className: 'grid grid-4'},
                                h('div', {className: 'indicator-box', style: {borderColor: '#3b82f6', background: 'rgba(59,130,246,0.2)'}},
                                    h('div', {className: 'text-xs'}, 'RSI'),
                                    h('div', {className: 'font-bold'}, marketData.indicators.rsi?.toFixed(1))
                                ),
                                h('div', {className: 'indicator-box', style: {borderColor: '#a855f7', background: 'rgba(168,85,247,0.2)'}},
                                    h('div', {className: 'text-xs'}, 'MACD'),
                                    h('div', {className: 'font-bold'}, marketData.indicators.macd?.histogram?.toFixed(2))
                                ),
                                h('div', {className: 'indicator-box', style: {borderColor: '#10b981', background: 'rgba(16,185,129,0.2)'}},
                                    h('div', {className: 'text-xs'}, 'ADX'),
                                    h('div', {className: 'font-bold'}, marketData.indicators.adx?.toFixed(1))
                                ),
                                h('div', {className: 'indicator-box', style: {borderColor: '#f97316', background: 'rgba(249,115,22,0.2)'}},
                                    h('div', {className: 'text-xs'}, 'ATR'),
                                    h('div', {className: 'font-bold'}, `$${marketData.indicators.atr?.toFixed(2)}`)
                                )
                            )
                        ),
                        analysis && h('div', {className: 'card'},
                            h('h3', null, 'ðŸ¤– AI Analysis'),
                            h('div', {className: `p-3 mb-3 ${analysis.direction === 'BULLISH' ? 'bullish' : analysis.direction === 'BEARISH' ? 'bearish' : 'neutral'}`, style: {borderRadius: '0.5rem'}},
                                h('div', {className: 'flex-between'},
                                    h('span', {className: 'font-bold', style: {fontSize: '1.5rem'}}, analysis.direction),
                                    h('span', {className: 'font-bold'}, `${analysis.confidence}%`)
                                )
                            ),
                            h('div', {className: `p-3 mb-3 ${analysis.recommendation === 'BUY' ? 'bullish' : analysis.recommendation === 'SELL' ? 'bearish' : 'neutral'}`, style: {borderRadius: '0.5rem'}},
                                h('div', {className: 'font-bold mb-2'}, `ðŸ“¢ ${analysis.recommendation}`),
                                h('p', {className: 'text-sm'}, analysis.reasoning)
                            ),
                            h('div', {className: 'grid grid-2'},
                                h('div', {className: 'stat-box'},
                                    h('div', {className: 'font-bold mb-2'}, 'Trade Setup'),
                                    h('div', {className: 'text-sm space-y-2'},
                                        h('div', {className: 'flex-between'}, h('span', null, 'Entry:'), h('span', {className: 'font-bold'}, `$${analysis.entryPoint}`)),
                                        h('div', {className: 'flex-between'}, h('span', null, 'Stop Loss:'), h('span', {className: 'font-bold', style: {color: '#fca5a5'}}, `$${analysis.stopLoss}`)),
                                        h('div', {className: 'flex-between'}, h('span', null, 'Take Profit:'), h('span', {className: 'font-bold', style: {color: '#86efac'}}, `$${analysis.takeProfit}`))
                                    )
                                ),
                                h('div', {className: 'stat-box'},
                                    h('div', {className: 'font-bold mb-2'}, 'Patterns'),
                                    ...analysis.patterns.map((p, i) => h('span', {key: i, className: 'badge mr-2', style: {background: '#3b82f6'}}, p))
                                )
                            )
                        ),
                        multiTFData && h('div', {className: 'card'},
                            h('h3', null, 'ðŸ“ˆ Multi-Timeframe'),
                            h('div', {className: 'grid grid-3'},
                                ...Object.entries(multiTFData).map(([tf, data]) => {
                                    if (!data?.indicators) return null;
                                    const rsi = data.indicators.rsi;
                                    const trend = rsi > 70 ? 'Overbought' : rsi < 30 ? 'Oversold' : 'Neutral';
                                    return h('div', {key: tf, className: `p-3 ${trend === 'Overbought' ? 'bearish' : trend === 'Oversold' ? 'bullish' : 'neutral'}`, style: {borderRadius: '0.5rem'}},
                                        h('h4', {className: 'font-bold mb-2'}, tf),
                                        h('div', {className: 'text-sm'}, `RSI: ${rsi.toFixed(1)}`),
                                        h('div', {className: 'text-sm'}, `Price: $${data.price.toLocaleString()}`),
                                        h('div', {className: 'font-bold text-sm mt-2'}, trend)
                                    );
                                })
                            )
                        )
                    )
                ),
                h('div', {className: 'alert alert-warning', style: {textAlign: 'center'}}, 'âš ï¸ Educational purposes only. Trade at your own risk.')
            );
        }
        
        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>
