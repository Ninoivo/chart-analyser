<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading System Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e3a8a 50%,#0f172a 100%);min-height:100vh;color:#fff}
        .container{max-width:1600px;margin:0 auto;padding:1rem}
        .btn{padding:0.75rem 1.5rem;border-radius:0.5rem;border:none;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:0.875rem}
        .btn:hover{opacity:0.9;transform:translateY(-1px)}
        .btn:active{transform:translateY(0)}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        .btn-primary{background:linear-gradient(135deg,#3b82f6,#06b6d4);color:#fff}
        .btn-success{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
        .btn-danger{background:linear-gradient(135deg,#f97316,#dc2626);color:#fff}
        .btn-purple{background:#9333ea;color:#fff}
        .btn-gray{background:#4b5563;color:#fff}
        .btn-yellow{background:#eab308;color:#000}
        .btn-green{background:#16a34a;color:#fff}
        .btn-indigo{background:#6366f1;color:#fff}
        .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:1rem;padding:1.5rem;border:1px solid rgba(255,255,255,0.2);margin-bottom:1.5rem}
        .grid{display:grid;gap:1.5rem}
        .grid-3{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
        .grid-2{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
        .grid-4{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
        input,select{width:100%;padding:0.75rem;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:0.5rem;color:#fff;margin-bottom:0.5rem}
        input::placeholder{color:rgba(255,255,255,0.5)}
        .stat-box{background:rgba(255,255,255,0.05);padding:1rem;border-radius:0.5rem;text-align:center}
        .indicator-box{padding:0.75rem;border-radius:0.5rem;border:2px solid}
        .bullish{background:rgba(16,185,129,0.2);border-color:#10b981}
        .bearish{background:rgba(239,68,68,0.2);border-color:#ef4444}
        .neutral{background:rgba(59,130,246,0.2);border-color:#3b82f6}
        .pulse{animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .flex{display:flex;gap:0.75rem;flex-wrap:wrap;align-items:center}
        .flex-between{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
        .text-sm{font-size:0.875rem}
        .text-xs{font-size:0.75rem}
        .font-bold{font-weight:700}
        .mb-2{margin-bottom:0.5rem}
        .mb-3{margin-bottom:0.75rem}
        .mb-4{margin-bottom:1rem}
        .mt-2{margin-top:0.5rem}
        .mt-3{margin-top:0.75rem}
        .mt-4{margin-top:1rem}
        .p-2{padding:0.5rem}
        .p-3{padding:0.75rem}
        .badge{display:inline-block;padding:0.25rem 0.75rem;border-radius:9999px;font-size:0.75rem;font-weight:600}
        .overflow-auto{overflow-y:auto;max-height:400px}
        h1{font-size:2rem;text-align:center;margin-bottom:0.5rem}
        h3{font-size:1.25rem;margin-bottom:0.75rem}
        .alert{padding:0.75rem;border-radius:0.5rem;margin-bottom:1rem;border:2px solid}
        .position-item{padding:0.75rem;border-radius:0.5rem;border:2px solid;margin-bottom:0.5rem}
        .mover-item{padding:0.75rem;border-radius:0.5rem;border:2px solid}
        .order-item{padding:0.5rem;border-radius:0.25rem;display:flex;justify-content:space-between;font-family:monospace;font-size:0.875rem}
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
    (function(){
        const {useState,useEffect,useRef,createElement:h}=React;
        
        function App(){
            const [data,setData]=useState(null);
            const [analysis,setAnalysis]=useState(null);
            const [loading,setLoading]=useState(false);
            const [symbol,setSymbol]=useState('BTCUSD');
            const [timeframe,setTimeframe]=useState('1H');
            const [listening,setListening]=useState(false);
            const [voiceText,setVoiceText]=useState('');
            const [broker,setBroker]=useState(null);
            const [selectedBroker,setSelectedBroker]=useState('demo');
            const [size,setSize]=useState(1);
            const [portfolio,setPortfolio]=useState([]);
            const [movers,setMovers]=useState(null);
            const [orderBook,setOrderBook]=useState(null);
            const [showMovers,setShowMovers]=useState(false);
            const [showDepth,setShowDepth]=useState(false);
            const [showSettings,setShowSettings]=useState(false);
            const [showPortfolio,setShowPortfolio]=useState(false);
            const [autoRefresh,setAutoRefresh]=useState(false);
            const [apiKeys,setApiKeys]=useState({
                alphavantage:localStorage.getItem('alphavantage_key')||'',
                twelvedata:localStorage.getItem('twelvedata_key')||''
            });
            const recog=useRef(null);
            
            useEffect(()=>{
                const saved=localStorage.getItem('portfolio');
                if(saved)setPortfolio(JSON.parse(saved));
                
                if('webkitSpeechRecognition' in window){
                    const r=new webkitSpeechRecognition();
                    r.continuous=false;
                    r.onresult=e=>{
                        const t=e.results[0][0].transcript;
                        setVoiceText(t);
                        processVoice(t);
                    };
                    r.onend=()=>setListening(false);
                    recog.current=r;
                }
            },[]);
            
            useEffect(()=>{
                if(autoRefresh&&symbol){
                    const iv=setInterval(()=>fetchData(symbol),30000);
                    return()=>clearInterval(iv);
                }
            },[autoRefresh,symbol]);
            
            const speak=t=>{
                if('speechSynthesis' in window){
                    speechSynthesis.cancel();
                    const u=new SpeechSynthesisUtterance(t);
                    speechSynthesis.speak(u);
                }
            };
            
            const toggleVoice=()=>{
                if(!recog.current)return alert('Voice not supported. Use Chrome or Edge.');
                if(listening){
                    recog.current.stop();
                }else{
                    try{
                        recog.current.start();
                        setListening(true);
                        speak('Listening');
                    }catch(e){
                        alert('Microphone error: '+e.message);
                    }
                }
            };
            
            const processVoice=text=>{
                const l=text.toLowerCase();
                let s='BTCUSD';
                if(l.includes('bitcoin')||l.includes('btc'))s='BTCUSD';
                else if(l.includes('ethereum')||l.includes('eth'))s='ETHUSD';
                else if(l.includes('euro'))s='EURUSD';
                else if(l.includes('gold'))s='XAUUSD';
                else if(l.includes('ripple')||l.includes('xrp'))s='XRPUSD';
                else if(l.includes('solana')||l.includes('sol'))s='SOLUSD';
                else if(l.includes('apple'))s='AAPL';
                else if(l.includes('tesla'))s='TSLA';
                
                if(l.includes('movers')||l.includes('gainers')){
                    setShowMovers(true);
                    fetchMovers();
                    speak('Loading movers');
                    return;
                }
                if(l.includes('depth')||l.includes('order book')){
                    setShowDepth(true);
                    fetchDepth(s);
                    speak('Loading depth');
                    return;
                }
                
                setSymbol(s);
                speak('Analyzing '+s);
                fetchData(s);
            };
            
            const fetchData=async s=>{
                setLoading(true);
                try{
                    const r=await fetch('/.netlify/functions/market-data',{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({symbol:s,timeframe,apiKeys})
                    });
                    const d=await r.json();
                    setData(d);
                    analyze(d);
                    speak('Data loaded');
                }catch(e){
                    console.error(e);
                    const demo=getDemo(s);
                    setData(demo);
                    analyze(demo);
                }finally{
                    setLoading(false);
                }
            };
            
            const getDemo=s=>{
                const p=s.includes('BTC')?43250:s.includes('ETH')?2280:1.0856;
                return{
                    symbol:s,source:'Demo',price:p,changePercent:1.2,
                    high24h:p*1.015,low24h:p*0.985,
                    indicators:{rsi:55,macd:{histogram:7.3},ema20:p*0.995,adx:28.5,atr:p*0.02},
                    patterns:['Uptrend'],supportResistance:{support:[p*0.97],resistance:[p*1.03]}
                };
            };
            
            const analyze=d=>{
                if(!d.indicators)return;
                const rsi=d.indicators.rsi;
                const p=d.price;
                let dir='NEUTRAL',conf=50,rec='HOLD';
                if(rsi<30){dir='BULLISH';rec='BUY';conf=75}
                else if(rsi>70){dir='BEARISH';rec='SELL';conf=75}
                setAnalysis({
                    direction:dir,confidence:conf,recommendation:rec,
                    entryPoint:p.toFixed(2),stopLoss:(p*0.98).toFixed(2),
                    takeProfit:(p*1.05).toFixed(2),reasoning:'RSI: '+rsi.toFixed(1),
                    patterns:d.patterns||[],keyLevels:d.supportResistance||{}
                });
            };
            
            const connect=()=>{
                speak('Connecting');
                setTimeout(()=>{
                    setBroker({name:selectedBroker,balance:50000,equity:50250});
                    speak('Connected');
                },1500);
            };
            
            const addPos=()=>{
                if(!analysis)return alert('Analyze market first');
                const pos={
                    id:Date.now(),symbol,entry:parseFloat(analysis.entryPoint),
                    size,direction:analysis.recommendation
                };
                const u=[...portfolio,pos];
                setPortfolio(u);
                localStorage.setItem('portfolio',JSON.stringify(u));
                speak('Added to portfolio');
            };
            
            const closePos=id=>{
                const p=portfolio.find(p=>p.id===id);
                if(!p)return;
                const cur=data?.price||p.entry;
                const pnl=p.direction==='BUY'?(cur-p.entry)*p.size:(p.entry-cur)*p.size;
                const u=portfolio.filter(p=>p.id!==id);
                setPortfolio(u);
                localStorage.setItem('portfolio',JSON.stringify(u));
                speak('Closed. '+(pnl>0?'Profit':'Loss')+' '+Math.abs(pnl).toFixed(2));
            };
            
            const fetchMovers=async()=>{
                try{
                    const r=await fetch('/.netlify/functions/market-movers');
                    const d=await r.json();
                    setMovers(d);
                    speak('Movers loaded');
                }catch(e){
                    console.error(e);
                    speak('Failed to load movers');
                }
            };
            
            const fetchDepth=async s=>{
                try{
                    const bs=s.replace('USD','USDT').replace('/','');
                    const r=await fetch('https://api.binance.com/api/v3/depth?symbol='+bs+'&limit=10');
                    const d=await r.json();
                    const bids=d.bids.map(([p,q])=>({price:parseFloat(p),qty:parseFloat(q)}));
                    const asks=d.asks.map(([p,q])=>({price:parseFloat(p),qty:parseFloat(q)}));
                    const tb=bids.reduce((s,b)=>s+b.qty,0);
                    const ta=asks.reduce((s,a)=>s+a.qty,0);
                    const bp=(tb/(tb+ta)*100).toFixed(1);
                    setOrderBook({symbol:s,bids,asks,buyPressure:parseFloat(bp),sellPressure:(100-bp).toFixed(1)});
                    speak('Depth loaded. Buy pressure '+bp+' percent');
                }catch(e){
                    console.error(e);
                    speak('Failed to load depth');
                }
            };
            
            return h('div',{className:'container'},
                h('h1',null,'ü§ñ AI Trading System Pro'),
                h('p',{style:{textAlign:'center',marginBottom:'1.5rem',opacity:0.8}},'Real-time ‚Ä¢ Voice ‚Ä¢ Movers ‚Ä¢ Depth'),
                
                h('div',{className:'card'},
                    h('div',{className:'flex',style:{justifyContent:'space-between',flexWrap:'wrap'}},
                        h('div',{className:'flex'},
                            h('button',{className:'btn '+(listening?'btn-danger pulse':'btn-purple'),onClick:toggleVoice},listening?'üé§ Stop':'üé§ Voice'),
                            h('button',{className:'btn btn-purple',onClick:()=>setShowSettings(!showSettings)},'‚öôÔ∏è Settings'),
                            h('button',{className:'btn '+(autoRefresh?'btn-success pulse':'btn-gray'),onClick:()=>setAutoRefresh(!autoRefresh)},'üîÑ '+(autoRefresh?'ON':'OFF')),
                            h('button',{className:'btn btn-green',onClick:()=>{setShowMovers(!showMovers);if(!showMovers)fetchMovers()}},'üî• Movers'),
                            h('button',{className:'btn btn-yellow',onClick:()=>{setShowDepth(!showDepth);if(!showDepth)fetchDepth(symbol)}},'üìä Depth'),
                            h('button',{className:'btn btn-indigo',onClick:()=>setShowPortfolio(!showPortfolio)},'üíº ('+portfolio.length+')')
                        ),
                        voiceText&&h('div',{className:'badge',style:{background:'#3b82f6'}},'"'+voiceText+'"')
                    ),
                    listening&&h('div',{className:'mt-3',style:{background:'rgba(147,51,234,0.2)',border:'2px solid #9333ea',borderRadius:'0.5rem',padding:'0.75rem'}},
                        h('p',{className:'text-sm',style:{color:'#e9d5ff',marginBottom:'0.5rem'}},'üí° Say: "Bitcoin", "Show movers", "Order book", "Tesla"')
                    ),
                    showSettings&&h('div',{className:'mt-3',style:{background:'rgba(255,255,255,0.05)',padding:'1rem',borderRadius:'0.5rem'}},
                        h('h3',{style:{fontSize:'1rem'}},'‚öôÔ∏è API Keys'),
                        h('label',{className:'text-sm',style:{display:'block',marginBottom:'0.5rem'}},'Twelve Data (Forex/Stocks)'),
                        h('input',{
                            type:'password',
                            value:apiKeys.twelvedata,
                            onChange:e=>{
                                const nk={...apiKeys,twelvedata:e.target.value};
                                setApiKeys(nk);
                                localStorage.setItem('twelvedata_key',e.target.value);
                            },
                            placeholder:'Optional API key'
                        }),
                        h('p',{className:'text-xs',style:{color:'#86efac'}},'‚úÖ Crypto & Forex work without keys!')
                    )
                ),
                
                h('div',{className:'grid grid-3'},
                    h('div',{className:'card'},
                        h('h3',null,'üìä Market'),
                        h('input',{type:'text',value:symbol,onChange:e=>setSymbol(e.target.value.toUpperCase()),placeholder:'Symbol (BTCUSD)'}),
                        h('select',{value:timeframe,onChange:e=>setTimeframe(e.target.value)},
                            ['1M','5M','15M','1H','4H','1D'].map(t=>h('option',{key:t,value:t},t))
                        ),
                        h('button',{className:'btn btn-primary',style:{width:'100%'},onClick:()=>fetchData(symbol),disabled:loading},loading?'‚è≥ Loading':'üîç Analyze'),
                        h('div',{className:'mt-4'},
                            h('h3',null,'üí∞ Broker'),
                            h('select',{value:selectedBroker,onChange:e=>setSelectedBroker(e.target.value)},
                                [{v:'demo',l:'Demo'},{v:'mt4',l:'MT4'},{v:'mt5',l:'MT5'},{v:'binance',l:'Binance'}].map(b=>h('option',{key:b.v,value:b.v},b.l))
                            ),
                            !broker?h('button',{className:'btn btn-success',style:{width:'100%'},onClick:connect},'üîå Connect'):
                            h('div',{className:'alert bullish'},
                                h('div',{className:'font-bold'},'‚úÖ '+broker.name.toUpperCase()),
                                h('div',{className:'text-sm'},'Balance: $'+broker.balance.toLocaleString())
                            )
                        ),
                        h('div',{className:'mt-4'},
                            h('h3',null,'üéØ Execute'),
                            h('input',{type:'number',value:size,onChange:e=>setSize(parseFloat(e.target.value)||1),step:0.01,min:0.01,placeholder:'Lots'}),
                            h('button',{className:'btn btn-danger',style:{width:'100%'},onClick:addPos,disabled:!analysis},'‚ö° Execute Trade')
                        )
                    ),
                    
                    h('div',{style:{gridColumn:'span 2'}},
                        data&&h('div',{className:'card'},
                            h('div',{className:'flex-between mb-3'},
                                h('h3',null,data.symbol),
                                h('span',{className:'badge',style:{background:'#3b82f6'}},data.source)
                            ),
                            h('div',{className:'grid grid-4 mb-3'},
                                [
                                    ['Price','$'+(data.price?.toLocaleString()||'N/A'),'#fff'],
                                    ['Change',(data.changePercent>0?'+':'')+data.changePercent+'%',data.changePercent>0?'#10b981':'#ef4444'],
                                    ['High','$'+(data.high24h?.toLocaleString()||'N/A'),'#fff'],
                                    ['Low','$'+(data.low24h?.toLocaleString()||'N/A'),'#fff']
                                ].map(([l,v,c],i)=>h('div',{key:i,className:'stat-box'},
                                    h('div',{className:'text-sm',style:{opacity:0.7}},l),
                                    h('div',{className:'font-bold',style:{fontSize:'1.25rem',color:c}},v)
                                ))
                            ),
                            data.indicators&&h('div',{className:'grid grid-4'},
                                [
                                    ['RSI',data.indicators.rsi?.toFixed(1),'#3b82f6'],
                                    ['MACD',data.indicators.macd?.histogram?.toFixed(2),'#a855f7'],
                                    ['ADX',data.indicators.adx?.toFixed(1),'#10b981'],
                                    ['ATR','$'+data.indicators.atr?.toFixed(2),'#f97316']
                                ].map(([l,v,c],i)=>h('div',{key:i,className:'indicator-box',style:{borderColor:c,background:c+'33'}},
                                    h('div',{className:'text-xs'},l),
                                    h('div',{className:'font-bold'},v)
                                ))
                            )
                        ),
                        analysis&&h('div',{className:'card'},
                            h('h3',null,'ü§ñ AI Analysis'),
                            h('div',{className:'p-3 mb-3 '+(analysis.direction==='BULLISH'?'bullish':analysis.direction==='BEARISH'?'bearish':'neutral'),style:{borderRadius:'0.5rem'}},
                                h('div',{className:'flex-between'},
                                    h('span',{className:'font-bold',style:{fontSize:'1.5rem'}},analysis.direction),
                                    h('span',{className:'font-bold'},analysis.confidence+'%')
                                )
                            ),
                            h('div',{className:'p-3 '+(analysis.recommendation==='BUY'?'bullish':analysis.recommendation==='SELL'?'bearish':'neutral')},
                                h('div',{className:'font-bold mb-2'},'üì¢ '+analysis.recommendation),
                                h('p',{className:'text-sm'},analysis.reasoning)
                            )
                        ),
                        showMovers&&movers&&h('div',{className:'card'},
                            h('h3',null,'üî• Market Movers'),
                            h('div',{className:'grid grid-2'},
                                h('div',null,
                                    h('h4',{style:{color:'#86efac',marginBottom:'0.5rem',fontSize:'1rem'}},'üìà Top Gainers'),
                                    h('div',{className:'overflow-auto'},
                                        movers.gainers.slice(0,8).map((c,i)=>h('div',{key:i,className:'mover-item bullish mb-2'},
                                            h('div',{className:'flex-between'},
                                                h('div',null,
                                                    h('div',{className:'font-bold text-sm'},c.symbol),
                                                    h('div',{className:'text-xs'},'$'+c.price.toLocaleString())
                                                ),
                                                h('div',{className:'font-bold',style:{color:'#86efac'}},'+'+c.changePercent.toFixed(2)+'%')
                                            )
                                        ))
                                    )
                                ),
                                h('div',null,
                                    h('h4',{style:{color:'#fca5a5',marginBottom:'0.5rem',fontSize:'1rem'}},'üìâ Top Losers'),
                                    h('div',{className:'overflow-auto'},
                                        movers.losers.slice(0,8).map((c,i)=>h('div',{key:i,className:'mover-item bearish mb-2'},
                                            h('div',{className:'flex-between'},
                                                h('div',null,
                                                    h('div',{className:'font-bold text-sm'},c.symbol),
                                                    h('div',{className:'text-xs'},'$'+c.price.toLocaleString())
                                                ),
                                                h('div',{className:'font-bold',style:{color:'#fca5a5'}},c.changePercent.toFixed(2)+'%')
                                            )
                                        ))
                                    )
                                )
                            )
                        ),
                        showDepth&&orderBook&&h('div',{className:'card'},
                            h('h3',null,'üìä Order Book - '+orderBook.symbol),
                            h('div',{className:'grid grid-2 mb-3'},
                                h('div',{className:'p-3 bullish',style:{textAlign:'center',borderRadius:'0.5rem'}},
                                    h('div',{className:'text-sm'},'Buy Pressure'),
                                    h('div',{className:'font-bold',style:{fontSize:'2rem'}},orderBook.buyPressure+'%')
                                ),
                                h('div',{className:'p-3 bearish',style:{textAlign:'center',borderRadius:'0.5rem'}},
                                    h('div',{className:'text-sm'},'Sell Pressure'),
                                    h('div',{className:'font-bold',style:{fontSize:'2rem'}},orderBook.sellPressure+'%')
                                )
                            ),
                            h('div',{className:'grid grid-2'},
                                h('div',null,
                                    h('h4',{style:{color:'#86efac',marginBottom:'0.5rem',fontSize:'1rem'}},'Bids'),
                                    orderBook.bids.map((b,i)=>h('div',{key:i,className:'order-item',style:{background:'rgba(16,185,129,0.1)',marginBottom:'0.25rem'}},
                                        h('span',{style:{color:'#86efac'}},'$'+b.price.toFixed(2)),
                                        h('span',null,b.qty.toFixed(4))
                                    ))
                                ),
                                h('div',null,
                                    h('h4',{style:{color:'#fca5a5',marginBottom:'0.5rem',fontSize:'1rem'}},'Asks'),
                                    orderBook.asks.map((a,i)=>h('div',{key:i,className:'order-item',style:{background:'rgba(239,68,68,0.1)',marginBottom:'0.25rem'}},
                                        h('span',{style:{color:'#fca5a5'}},'$'+a.price.toFixed(2)),
                                        h('span',null,a.qty.toFixed(4))
                                    ))
                                )
                            )
                        ),
                        showPortfolio&&portfolio.length>0&&h('div',{className:'card'},
                            h('h3',null,'üíº Active Portfolio'),
                            portfolio.map(p=>{
                                const cur=data?.symbol===p.symbol?data.price:p.entry;
                                const pnl=p.direction==='BUY'?(cur-p.entry)*p.size:(p.entry-cur)*p.size;
                                return h('div',{key:p.id,className:'position-item '+(pnl>=0?'bullish':'bearish')},
                                    h('div',{className:'flex-between'},
                                        h('div',null,
                                            h('div',{className:'font-bold'},p.symbol+' - '+p.direction),
                                            h('div',{className:'text-xs'},'Entry: $'+p.entry+' | Size: '+p.size),
                                            h('div',{className:'font-bold text-sm'},'P/L: $'+pnl.toFixed(2)+' ('+(pnl/p.entry*100).toFixed(2)+'%)')
                                        ),
                                        h('button',{className:'btn btn-danger',style:{padding:'0.5rem 1rem'},onClick:()=>closePos(p.id)},'Close')
                                    )
                                );
                            })
                        )
                    )
                ),
                h('div',{className:'alert',style:{textAlign:'center',borderColor:'#eab308',background:'rgba(234,179,8,0.2)',color:'#fef3c7'}},'‚ö†Ô∏è Educational purposes only. Trade at your own risk.')
            );
        }
        
        ReactDOM.render(React.createElement(App),document.getElementById('root'));
    })();
    </script>
</body>
</html>
